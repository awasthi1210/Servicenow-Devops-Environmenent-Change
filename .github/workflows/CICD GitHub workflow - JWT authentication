name: CICD GitHub workflow - JWT authentication
'on': workflow_dispatch
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: temurin
          cache: maven
      - name: Build with Maven
        run: mvn clean compile
  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Run Tests with Maven
        run: mvn -B test --file pom.xml
      - name: ServiceNow DevOps Unit Test Results
        uses: ServiceNow/servicenow-devops-test-report@dev
        with:
          devops-integration-user-name: '${{ secrets.SN_DEVOPS_USER }}'
          devops-integration-user-password: '${{ secrets.SN_DEVOPS_PASSWORD }}'
          instance-url: '${{ secrets.SN_INSTANCE_URL }}'
          tool-id: '${{ secrets.SN_ORCHESTRATION_TOOL_ID }}'
          job-name: Test
          test-summary-name: Mona Test Summary
          context-github: '${{ toJSON(github) }}'
          xml-report-filename: target/
  registerArtifact:
    name: Register Artifact
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: ServiceNow DevOps Register Artifact
        uses: ServiceNow/servicenow-devops-register-artifact@dev
        with:
          devops-integration-user-name: '${{ secrets.SN_DEVOPS_USER }}'
          devops-integration-user-password: '${{ secrets.SN_DEVOPS_PASSWORD }}'
          instance-url: '${{ secrets.SN_INSTANCE_URL }}'
          tool-id: '${{ secrets.SN_ORCHESTRATION_TOOL_ID }}'
          job-name: Register Artifact
          context-github: '${{ toJSON(github) }}'
          artifacts: >-
            [ { "name": "app-devops-cicd.jar", "version": "1.${{
            github.run_number }}", "semanticVersion": "1.${{ github.run_number
            }}.0", "repositoryName": "${{ github.repository }}" } ]
  registerPackage:
    name: Register Package
    needs:
      - registerArtifact
    runs-on: ubuntu-latest
    steps:
      - name: ServiceNow DevOps Register Package
        uses: ServiceNow/servicenow-devops-register-package@dev
        with:
          devops-integration-user-name: '${{ secrets.SN_DEVOPS_USER }}'
          devops-integration-user-password: '${{ secrets.SN_DEVOPS_PASSWORD }}'
          instance-url: '${{ secrets.SN_INSTANCE_URL }}'
          tool-id: '${{ secrets.SN_ORCHESTRATION_TOOL_ID }}'
          context-github: '${{ toJSON(github) }}'
          artifacts: >-
            [ { "name": "app-devops-cicd.jar", "version": "1.${{
            github.run_number }}", "semanticVersion": "1.${{ github.run_number
            }}.0", "repositoryName": "${{ github.repository }}" } ]
          package-name: app-devops-change-velocity-cicd.war
          job-name: Register Package
  change:
    name: Change Request
    if: always()
    needs: registerPackage
    runs-on: ubuntu-latest
    steps:
      - name: ServiceNow DevOps Change Attributes
        uses: ServiceNow/servicenow-devops-change@v5.1.0
        with:
          devops-integration-token: '${{ secrets.SN_DEVOPS_TOKEN }}'
          instance-url: '${{ secrets.SN_INSTANCE_URL }}'
          tool-id: '${{ secrets.SN_ORCHESTRATION_TOOL_ID }}'
          context-github: '${{ toJSON(github) }}'
          job-name: Change Request
          change-request: >-
            {"autoCloseChange":true,"attributes":{"chg_model": {"name": "Normal"
            },"short_description":"Automated Software
            Deployments","description":"Automated Software
            Deployment.","assignment_group":"a715cd759f2002002920bde8132e7018","implementation_plan":"Software
            update is tested and results can be found in Test Summaries
            Tab.","backout_plan":"When software fails in production, the
            previous software release will be re-deployed.","test_plan":"Testing
            if the software was successfully deployed."}}
          interval: '100'
          timeout: '3600'
          changeCreationTimeOut: ;'1000'
          deployment-gate: '{"environment":"prod","jobName":"Deploy"}'
  deploy:
    name: Deploy
    needs: change
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Run deployment scripts
        run: echo Completed Deployment.
  getchange:
    needs: deploy
    runs-on: ubuntu-latest
    name: ServiceNow DevOps Get Change
    outputs:
      change-request-number: '${{ steps.get_change.outputs.change-request-number }}'
    steps:
      - name: ServiceNow DevOps Get Change
        uses: ServiceNow/servicenow-devops-get-change@dev
        id: get_change
        with:
          instance-url: '${{ secrets.SN_INSTANCE_URL }}'
          devops-integration-user-name: '${{ secrets.SN_DEVOPS_USER }}'
          devops-integration-user-password: '${{ secrets.SN_DEVOPS_PASSWORD }}'
          tool-id: '${{ secrets.SN_ORCHESTRATION_TOOL_ID }}'
          context-github: '${{ toJSON(github) }}'
          change-details: >-
            {"build_number":"${{github.run_id}}","pipeline_name":"${{github.repository}}/${{github.workflow}}","stage_name":"ServiceNow
            DevOps Change"}
      - name: Output of ServiceNow DevOps Get Change
        run: >-
          echo 'Output of ServiceNow DevOps Get Change is ->
          change-request-number = ${{
          steps.get_change.outputs.change-request-number }}' >> $GITHUB_OUTPUT
  updatechange:
    needs: getchange
    runs-on: ubuntu-latest
    name: ServiceNow DevOps Update Change
    steps:
      - name: ServiceNow DevOps Update Change
        uses: ServiceNow/servicenow-devops-update-change@dev
        id: update_change
        with:
          instance-url: '${{ secrets.SN_INSTANCE_URL }}'
          devops-integration-user-name: '${{ secrets.SN_DEVOPS_USER }}'
          devops-integration-user-password: '${{ secrets.SN_DEVOPS_PASSWORD }}'
          tool-id: '${{ secrets.SN_ORCHESTRATION_TOOL_ID }}'
          context-github: '${{ toJSON(github) }}'
          change-request-number: '${{needs.getchange.outputs.change-request-number}}'
          change-request-details: >-
            {"state":"3","close_code":"successful_issues","close_notes":"Test
            results successful"}
